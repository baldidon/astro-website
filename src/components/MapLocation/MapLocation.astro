---
// Questo componente carica e visualizza una mappa Leaflet

const {
	lat = 43.34947739851581,
	lng = 12.578185021304732,
	zoom = 16,
	height = "400px",
} = Astro.props;
---

<div id="map" style={`height: ${height};`} class="w-full rounded-lg overflow-hidden" data-lat={lat} data-lng={lng} data-zoom={zoom}></div>
<link
	rel="stylesheet"
	href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
	integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
	crossorigin=""
/>

<script>
	// Carica Leaflet dinamicamente
	function loadLeaflet() {
		return new Promise((resolve, reject) => {
			// Se Leaflet è già caricato, risolvi subito
			if (window.L) {
				resolve(window.L);
				return;
			}

			// Carica lo script di Leaflet
			const script = document.createElement('script');
			script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
			script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo='
			script.crossOrigin = '';
			script.onload = () => resolve(window.L);
			script.onerror = reject;
			document.head.appendChild(script);
		});
	}

	// Funzione per inizializzare la mappa
	async function initMap() {
		// Ottieni le coordinate dagli attributi data
		const mapElement = document.getElementById("map");
		const lat = parseFloat(mapElement.dataset.lat);
		const lng = parseFloat(mapElement.dataset.lng);
		const zoom = parseInt(mapElement.dataset.zoom);
		
		console.log("Inizializzazione mappa con lat:", lat, "lng:", lng, "zoom:", zoom);
		
		try {
			// Carica Leaflet
			const L = await loadLeaflet();
			console.log("Leaflet caricato");

			// Rimuovi mappa esistente se presente
			if (window.mapInstance) {
				window.mapInstance.remove();
				window.mapInstance = null;
			}

			if (!mapElement) {
				console.error("Elemento mappa non trovato");
				return;
			}

			// Inizializza la mappa con opzioni per bloccare lo scroll
			const map = L.map("map", {
				center: [lat, lng],
				zoom: zoom,
				scrollWheelZoom: false, // Disabilita zoom con scroll wheel
				touchZoom: false,      // Disabilita zoom con touch/pinch
				doubleClickZoom: false, // Disabilita zoom con double click
				boxZoom: false,        // Disabilita zoom con box selection
				keyboard: false,       // Disabilita controlli tastiera
				dragging: true,        // Mantiene dragging/panning
				tap: false            // Disabilita tap per zoom
			});
			console.log("Mappa creata");

			// Aggiungi il layer di OpenStreetMap
			L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
				attribution:
					'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
				maxZoom: 19,
			}).addTo(map);
			console.log("Tile layer aggiunto");

			// Icona personalizzata per il marker
			const customIcon = L.divIcon({
				html: '<div style="background-color: #dc2626; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
				iconSize: [20, 20],
				iconAnchor: [10, 10],
				popupAnchor: [0, -10],
				className: 'custom-marker'
			});

			// Aggiungi un marker alla posizione indicata
			L.marker([lat, lng], { icon: customIcon }).addTo(map);
			console.log("Marker aggiunto");

			// Salva l'istanza della mappa globalmente
			window.mapInstance = map;

			// Correggi il problema di dimensioni dopo un breve ritardo
			setTimeout(() => {
				map.invalidateSize();
				console.log("Mappa ridimensionata");
			}, 200);

		} catch (error) {
			console.error("Errore durante l'inizializzazione della mappa:", error);
		}
	}

	// Inizializza la mappa quando il DOM è pronto
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initMap);
	} else {
		// Se il DOM è già caricato, attendi un momento per assicurarti che l'elemento sia disponibile
		setTimeout(initMap, 100);
	}

	// Reinizializza la mappa quando la pagina cambia (per Astro view transitions)
	document.addEventListener('astro:after-swap', () => {
		setTimeout(initMap, 100);
	});

	// Reinizializza quando la finestra viene ridimensionata
	let resizeTimeout;
	window.addEventListener('resize', () => {
		clearTimeout(resizeTimeout);
		resizeTimeout = setTimeout(() => {
			if (window.mapInstance) {
				window.mapInstance.invalidateSize();
			}
		}, 250);
	});

	// Previene lo scroll della pagina quando si interagisce con la mappa
	function preventMapScroll(e) {
		e.preventDefault();
	}

	// Aggiungi event listeners per bloccare scroll sulla mappa
	setTimeout(() => {
		const mapElement = document.getElementById("map");
		if (mapElement) {
			// Blocca scroll wheel sulla mappa
			mapElement.addEventListener('wheel', preventMapScroll, { passive: false });
			mapElement.addEventListener('touchmove', preventMapScroll, { passive: false });
			
			// Blocca scroll su tutti gli elementi interni alla mappa
			const mapContainer = mapElement.querySelector('.leaflet-container');
			if (mapContainer) {
				mapContainer.addEventListener('wheel', preventMapScroll, { passive: false });
				mapContainer.addEventListener('touchmove', preventMapScroll, { passive: false });
			}
		}
	}, 300);
</script>

<style>
	.custom-marker {
		background: transparent !important;
		border: none !important;
	}
	
	/* Fix per i tile della mappa */
	.leaflet-container {
		font-family: inherit;
	}
	
	.leaflet-tile-pane {
		z-index: 1;
	}

	/* Assicura che la mappa catturi tutti gli eventi di scroll */
	#map {
		touch-action: none;
		overscroll-behavior: none;
	}
	
	.leaflet-container {
		touch-action: none;
		overscroll-behavior: none;
	}
</script>

<style>
	.custom-marker {
		background: transparent !important;
		border: none !important;
	}
	
	/* Fix per i tile della mappa */
	.leaflet-container {
		font-family: inherit;
	}
	
	.leaflet-tile-pane {
		z-index: 1;
	}
</style>

